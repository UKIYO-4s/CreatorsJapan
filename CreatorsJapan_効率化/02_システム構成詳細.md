# システム構成詳細

## データフロー図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         月次自動処理フロー                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【毎月1日 AM 8:00 トリガー起動】                                         │
│                                                                         │
│      ┌─────────────┐                                                    │
│      │ GA4 Data API │                                                    │
│      │  (2サイト)   │                                                    │
│      └──────┬──────┘                                                    │
│             │                                                           │
│             ▼                                                           │
│      ┌─────────────┐     ┌─────────────┐     ┌─────────────┐           │
│      │ データ取得   │────▶│ データ整形   │────▶│ スプレッド   │           │
│      │  Script     │     │  Script     │     │  シート更新  │           │
│      └─────────────┘     └──────┬──────┘     └─────────────┘           │
│                                 │                                       │
│                                 ▼                                       │
│                          ┌─────────────┐                                │
│                          │ レポート生成  │                                │
│                          │  Script     │                                │
│                          └──────┬──────┘                                │
│                                 │                                       │
│             ┌───────────────────┼───────────────────┐                   │
│             │                   │                   │                   │
│             ▼                   ▼                   ▼                   │
│      ┌─────────────┐     ┌─────────────┐     ┌─────────────┐           │
│      │ Discord     │     │ Discord     │     │ ログ記録     │           │
│      │ #salon報告  │     │ #運営報告   │     │             │           │
│      └─────────────┘     └─────────────┘     └─────────────┘           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## コンポーネント詳細

### 1. Google Apps Script (GAS)

**ファイル構成**:
```
CreatorsJapan_Analytics/
├── main.gs              # メイン処理
├── ga4Api.gs            # GA4 API呼び出し
├── discord.gs           # Discord投稿
├── spreadsheet.gs       # スプレッドシート操作
├── archive.gs           # アーカイブ処理
├── config.gs            # 設定値
└── utils.gs             # ユーティリティ
```

**トリガー設定**:
| トリガー | 実行タイミング | 処理内容 |
|----------|----------------|----------|
| monthlyReport | 毎月1日 8:00 | 月次レポート生成・投稿 |
| dailyHealthCheck | 毎日 9:00 | システム死活監視 |
| yearlyArchive | 毎年1月15日 | 年次アーカイブ生成 |

---

### 2. GA4 Data API 連携

**認証方式**: サービスアカウント認証

**取得データ構造**:
```javascript
// 基本指標リクエスト
{
  "dateRanges": [
    { "startDate": "2026-01-01", "endDate": "2026-01-31" },  // 当月
    { "startDate": "2025-12-01", "endDate": "2025-12-31" }   // 前月（比較用）
  ],
  "metrics": [
    { "name": "screenPageViews" },      // PV
    { "name": "totalUsers" },           // ユーザー数
    { "name": "sessions" },             // セッション数
    { "name": "averageSessionDuration" }, // 平均滞在時間
    { "name": "bounceRate" },           // 直帰率
    { "name": "newUsers" },             // 新規ユーザー
    { "name": "engagedSessions" }       // エンゲージセッション
  ],
  "dimensions": [
    { "name": "date" }
  ]
}
```

**記事別データリクエスト**:
```javascript
{
  "dateRanges": [
    { "startDate": "2026-01-01", "endDate": "2026-01-31" }
  ],
  "metrics": [
    { "name": "screenPageViews" },
    { "name": "averageSessionDuration" },
    { "name": "bounceRate" }
  ],
  "dimensions": [
    { "name": "pagePath" },
    { "name": "pageTitle" }
  ],
  "orderBys": [
    { "metric": { "metricName": "screenPageViews" }, "desc": true }
  ],
  "limit": 50
}
```

---

### 3. Discord Webhook 設計

**Webhook URL管理**:
```javascript
const DISCORD_WEBHOOKS = {
  salon: "https://discord.com/api/webhooks/xxx/yyy",    // ライター向け
  public: "https://discord.com/api/webhooks/aaa/bbb"   // 運営向け
};
```

**投稿フォーマット（Embed形式）**:
```javascript
{
  "embeds": [{
    "title": "📊 月次レポート - 2026年1月",
    "description": "creators-jp.com のアクセス解析レポート",
    "color": 3447003,  // 青色
    "fields": [
      {
        "name": "📈 PV",
        "value": "45,230 (前月比 +12.3%)",
        "inline": true
      },
      {
        "name": "👥 ユーザー数",
        "value": "12,450 (前月比 +8.7%)",
        "inline": true
      },
      {
        "name": "⏱️ 平均滞在時間",
        "value": "2分34秒",
        "inline": true
      }
    ],
    "footer": {
      "text": "自動生成レポート | 詳細はスプレッドシート参照"
    },
    "timestamp": "2026-02-01T00:00:00.000Z"
  }]
}
```

---

### 4. スプレッドシート設計

**シート構成**:

#### ダッシュボード
| セル | 内容 | データソース |
|------|------|--------------|
| B2 | 当月PV | RAWデータから集計 |
| C2 | 前月比 | 自動計算 |
| B3 | ユーザー数 | RAWデータから集計 |
| ... | ... | ... |

#### 月次推移シート
| 列 | 内容 |
|----|------|
| A | 年月 |
| B | PV |
| C | ユーザー数 |
| D | セッション数 |
| E | 平均滞在時間 |
| F | 直帰率 |
| G | 新規率 |

#### 記事別パフォーマンス
| 列 | 内容 |
|----|------|
| A | 記事URL |
| B | 記事タイトル |
| C | PV |
| D | 平均滞在時間 |
| E | 直帰率 |
| F | 前月PV |
| G | 増減率 |

#### RAWデータ
| 列 | 内容 |
|----|------|
| A | 取得日時 |
| B | サイト |
| C | 日付 |
| D-J | 各指標値 |

---

### 5. アーカイブ処理

**年次アーカイブ生成フロー**:
```
1. 対象年のデータ抽出
   └─▶ スプレッドシートから1年分のデータ取得

2. PDF生成
   └─▶ 月次レポート × 12ヶ月分

3. Excel変換
   └─▶ スプレッドシートをxlsx形式でエクスポート

4. ZIP生成
   └─▶ Google Drive上でZIPファイル作成

5. 通知
   └─▶ Discord + メールで完了通知
   └─▶ ダウンロードリンク共有

6. 古いオンラインデータ削除
   └─▶ 1年以上前のRAWデータをクリア
```

**アーカイブ構造**:
```
CreatorsJapan_GA_Archive_2026.zip (約5-10MB想定)
│
├── 00_README.txt
│   └─ アーカイブ内容説明、データ定義
│
├── 01_月次レポート/
│   ├── 2026-01_creators-jp.pdf
│   ├── 2026-01_salon.pdf
│   ├── 2026-02_creators-jp.pdf
│   └── ... (計24ファイル)
│
├── 02_データ/
│   ├── creators-jp_2026_年間データ.xlsx
│   ├── salon_2026_年間データ.xlsx
│   └── 記事別パフォーマンス_2026.xlsx
│
└── 03_サマリー/
    └── 2026_年間サマリーレポート.pdf
```

---

## セキュリティ設計

### 認証・認可

| 項目 | 方式 |
|------|------|
| GA4 API | サービスアカウント（JSON鍵） |
| Discord | Webhook URL（シークレット） |
| スプレッドシート | GAS実行権限 |

### シークレット管理

```javascript
// PropertiesServiceで管理（コードに直書きしない）
const secrets = PropertiesService.getScriptProperties();

const GA4_PROPERTY_ID_PUBLIC = secrets.getProperty('GA4_PROPERTY_ID_PUBLIC');
const GA4_PROPERTY_ID_SALON = secrets.getProperty('GA4_PROPERTY_ID_SALON');
const DISCORD_WEBHOOK_SALON = secrets.getProperty('DISCORD_WEBHOOK_SALON');
const DISCORD_WEBHOOK_PUBLIC = secrets.getProperty('DISCORD_WEBHOOK_PUBLIC');
```

### アクセス制御

| リソース | 権限 |
|----------|------|
| GASプロジェクト | 管理者のみ編集可 |
| スプレッドシート | 限定公開（関係者のみ） |
| Discord Webhook | URL非公開 |
| サービスアカウント鍵 | GAS内部のみ保持 |

---

## エラーハンドリング

### 監視項目

| エラー種別 | 検知方法 | 対応 |
|------------|----------|------|
| API接続失敗 | try-catch | 3回リトライ後、管理者通知 |
| データ取得0件 | 件数チェック | 警告通知、手動確認依頼 |
| Discord投稿失敗 | HTTPステータス | リトライ後、メールで代替送信 |
| トリガー未実行 | 実行ログ監視 | 翌日に管理者通知 |

### 通知先

```javascript
const ADMIN_NOTIFICATION = {
  discord: "管理者DM or 専用チャンネル",
  email: "admin@example.com"
};
```

---

## 拡張性

### 将来的な拡張案

| 機能 | 概要 | 難易度 |
|------|------|--------|
| Search Console連携 | 検索キーワードデータ追加 | 中 |
| Slack対応 | Discord以外の通知先 | 低 |
| 複数クライアント対応 | 設定ファイルで切り替え | 中 |
| AIサマリー | ChatGPT APIで分析コメント自動生成 | 高 |
| アラート機能 | 異常値検知で即時通知 | 中 |

---

## 改訂履歴

| 日付 | 内容 |
|------|------|
| 2026/01/11 | 初版作成 |
