# 作業手順書

作業実施時のチェックリスト、エラー対処法、ロールバック手順をまとめます。

---

## 共通：作業前チェックリスト

すべての作業前に必ず実施する項目。

### 必須バックアップ

| バックアップ対象 | 方法 | 保存先 |
|-----------------|------|--------|
| データベース | サーバーパネル or phpMyAdmin | ローカルPC + クラウド |
| wp-content フォルダ | FTP | ローカルPC |
| .htaccess | FTP | ローカルPC |
| wp-config.php | FTP | ローカルPC |

**バックアップ手順**:

```
1. サーバーパネルにログイン
2. データベース → バックアップ → ダウンロード
3. FTPでwp-contentをダウンロード
4. .htaccess、wp-config.phpをダウンロード
5. ファイル名に日付を付けて保存（例: backup_20260111）
```

### 作業環境確認

- [ ] 低トラフィック時間帯か（深夜・早朝推奨）
- [ ] クライアントに作業予定を連絡済みか
- [ ] バックアップ取得完了か
- [ ] 復旧手順を確認したか
- [ ] 作業完了後の確認項目を把握しているか

---

## 1. プラグイン/テーマ更新

### 作業前チェックリスト

- [ ] バックアップ取得完了
- [ ] 更新内容（チェンジログ）確認
- [ ] PHP/WP互換性確認
- [ ] 重要な更新（セキュリティ修正）を優先リスト化

### 作業手順

```
1. 管理画面 → ダッシュボード → 更新
2. 一括更新は使わない（1件ずつ更新）
3. 1件更新するごとに:
   └─ サイト表示確認（トップページ）
   └─ 管理画面動作確認
   └─ 問題なければ次へ
4. 全件完了後、詳細確認を実施
```

### 更新後確認チェックリスト

| 確認項目 | 方法 | 合格基準 |
|----------|------|----------|
| トップページ | ブラウザで表示 | 崩れなし |
| 主要ページ（3-5ページ） | ブラウザで表示 | 崩れなし |
| 管理画面 | ログイン・操作 | エラーなし |
| コンソールエラー | 開発者ツール | エラーなし |
| お問い合わせフォーム | テスト送信 | 送信成功 |
| 会員機能（該当時） | ログイン・操作 | 正常動作 |

### エラー発生時の対処

| 症状 | 原因 | 対処法 |
|------|------|--------|
| **白い画面（WSOD）** | PHPエラー | FTPでプラグイン無効化（フォルダ名変更） |
| **500エラー** | メモリ不足/競合 | エラーログ確認、該当プラグイン無効化 |
| **表示崩れ（CSS）** | キャッシュ | キャッシュクリア（ブラウザ + サーバー） |
| **ショートコード表示** | プラグイン無効 | プラグイン再有効化 |
| **ログインできない** | セッション問題 | Cookieクリア、別ブラウザで試行 |

### ロールバック手順

```
【緊急時：FTPでプラグイン無効化】
1. FTPでサーバーに接続
2. /wp-content/plugins/ に移動
3. 問題のプラグインフォルダを「pluginname_disabled」にリネーム
4. サイト表示確認
5. 復旧したら原因調査

【完全ロールバック】
1. FTPでバックアップからプラグインフォルダを上書き
2. サーバーパネルでDBをバックアップから復元
3. サイト表示確認
```

---

## 2. プラグイン/テーマ削除

### 作業前チェックリスト

- [ ] バックアップ取得完了
- [ ] 削除対象の使用状況を確認
- [ ] クライアントに使用予定を確認済み
- [ ] ショートコードの使用箇所を検索済み

### 削除前の使用確認方法

```
【ショートコード検索】
1. 管理画面 → 投稿/固定ページ → 一覧
2. 検索欄にショートコード名を入力
   例: [contact-form] や [twitter-feed]
3. 該当があれば削除前に代替策を検討

【プラグイン機能の確認】
- フロントエンドで機能が動作しているか
- 管理画面で設定画面があるか
- 他のプラグインと連携しているか
```

### 作業手順

```
1. 管理画面 → プラグイン → 削除対象を確認
2. 「無効化」をクリック（まだ削除しない）
3. サイト表示確認
4. 問題なければ「削除」をクリック
5. 再度サイト表示確認
```

### 削除後確認チェックリスト

- [ ] サイト表示に問題なし
- [ ] コンソールエラーなし
- [ ] 該当機能が正しく無効化されている
- [ ] 他の機能に影響がない

### ロールバック手順

```
【プラグインの場合】
1. 管理画面 → プラグイン → 新規追加
2. 削除したプラグインを検索・インストール
3. 有効化
※ 設定は復元されない可能性あり

【テーマの場合】
1. 管理画面 → 外観 → テーマ → 新規追加
2. テーマを検索・インストール
3. 有効化（必要時のみ）
```

---

## 3. .htaccess 編集

### 作業前チェックリスト

- [ ] 現在の.htaccessをダウンロード済み
- [ ] 追加する内容を事前にレビュー
- [ ] 構文エラーがないか確認
- [ ] FTPアクセス情報を手元に用意

### 作業手順

```
1. FTPで.htaccessをダウンロード（バックアップ）
2. ファイル名を「.htaccess_backup_日付」に変更して保管
3. .htaccessを編集
   - 既存の内容は削除しない
   - 追加は「# BEGIN Custom」「# END Custom」で囲む
4. 編集後の.htaccessをアップロード
5. 即座にサイト表示確認
```

### 編集テンプレート

```apache
# ===== 既存のWordPress設定（触らない） =====
# BEGIN WordPress
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]
</IfModule>
# END WordPress

# ===== カスタム設定（ここに追加） =====
# BEGIN Custom Security
# セキュリティ設定をここに追加
# END Custom Security
```

### エラー発生時の対処

| 症状 | 原因 | 対処法 |
|------|------|--------|
| **500エラー** | 構文エラー | FTPでバックアップを上書きアップロード |
| **403エラー** | アクセス制限過剰 | 該当ルールを削除 |
| **リダイレクトループ** | RewriteRule設定ミス | バックアップから復元 |
| **サイトが表示されない** | 致命的エラー | 即座にバックアップから復元 |

### ロールバック手順

```
【即時復旧】
1. FTPでサーバーに接続
2. .htaccess を削除
3. .htaccess_backup をアップロード
4. .htaccess にリネーム
5. サイト表示確認
```

---

## 4. functions.php 編集

### 作業前チェックリスト

- [ ] 現在のfunctions.phpをダウンロード済み
- [ ] 追加するコードを事前にテスト
- [ ] PHP構文エラーがないか確認
- [ ] 子テーマのfunctions.phpを編集する（親テーマは触らない）

### 作業手順

```
1. 子テーマの functions.php をFTPでダウンロード
2. バックアップとして保管
3. コードを末尾に追加
   - PHPの閉じタグ ?> は書かない
   - コメントで何のコードか明記
4. アップロード
5. サイト表示確認
```

### 編集テンプレート

```php
<?php
// 既存のコード（触らない）
// ...

// ===== カスタムセキュリティ設定 =====
// 追加日: 2026-01-11
// 目的: REST APIコメント制限

add_filter('rest_pre_insert_comment', function($prepared_comment, $request) {
    return new WP_Error(
        'rest_comment_disabled',
        'REST API経由のコメント投稿は無効です',
        array('status' => 403)
    );
}, 10, 2);

// ===== カスタムセキュリティ設定ここまで =====
```

### エラー発生時の対処

| 症状 | 原因 | 対処法 |
|------|------|--------|
| **白い画面（WSOD）** | PHP構文エラー | FTPでバックアップを上書き |
| **Parse error** | 構文ミス | エラー行を確認し修正 |
| **500エラー** | 致命的エラー | FTPでバックアップを復元 |
| **特定機能が動かない** | コード競合 | 追加コードをコメントアウト |

### ロールバック手順

```
【即時復旧】
1. FTPでサーバーに接続
2. /wp-content/themes/[子テーマ名]/ に移動
3. functions.php をバックアップで上書き
4. サイト表示確認
```

---

## 5. サーバー設定変更

### 作業前チェックリスト

- [ ] サーバーパネルアクセス情報を確認
- [ ] 変更する設定を事前にメモ
- [ ] 現在の設定をスクリーンショット保存
- [ ] 変更の影響範囲を把握

### 作業手順（X-Serverの例）

```
【WAF設定変更】
1. サーバーパネルにログイン
2. セキュリティ → WAF設定
3. 対象ドメインを選択
4. 設定を変更
5. 変更前後をスクリーンショット
6. 反映を待つ（数分〜数十分）
7. サイト表示確認

【PHP設定変更】
1. サーバーパネルにログイン
2. PHP → PHP設定
3. 対象ドメインを選択
4. 設定変更
5. 反映を待つ
6. サイト表示確認
```

### 確認事項

- [ ] 設定変更が反映されているか
- [ ] サイト表示に問題ないか
- [ ] 管理画面が正常に動作するか
- [ ] SSL証明書に影響がないか

### ロールバック手順

```
【サーバーパネルから復元】
1. 変更した設定画面を開く
2. 元の設定に戻す
3. 反映を待つ
4. サイト表示確認
```

---

## 緊急連絡フロー

### 連絡先一覧

| 状況 | 連絡先 | 連絡方法 |
|------|--------|----------|
| サイト停止 | クライアント | 電話 → メール |
| 情報漏洩の疑い | クライアント | 電話（即時） |
| 軽微な表示崩れ | クライアント | メール |
| サーバー障害 | ホスティング会社 | サポート窓口 |

### 連絡テンプレート

**作業開始時**:
```
件名: 【作業開始】〇〇サイト セキュリティ対策

お世話になっております。
本日○時より、以下の作業を開始いたします。

■ 作業内容
- プラグイン更新（13件）
- テーマ更新（7件）

■ 作業時間
○時〜○時（予定）

■ 影響
作業中、一時的にサイトの表示が遅くなる可能性があります。

作業完了後、改めてご連絡いたします。
```

**作業完了時**:
```
件名: 【作業完了】〇〇サイト セキュリティ対策

お世話になっております。
本日の作業が完了いたしました。

■ 実施内容
- プラグイン更新: 13件完了
- テーマ更新: 7件完了

■ 確認結果
- サイト表示: 正常
- 管理画面: 正常
- 主要機能: 正常

ご確認をお願いいたします。
```

**問題発生時**:
```
件名: 【緊急】〇〇サイト 問題発生のご連絡

お世話になっております。
作業中に以下の問題が発生いたしました。

■ 発生した問題
[具体的な症状]

■ 現在の状況
[対応中/復旧済み]

■ 影響範囲
[サイト全体/一部ページ]

■ 今後の対応
[予定している対応]

詳細がわかり次第、改めてご連絡いたします。
```

---

## 作業完了チェックリスト

### 最終確認

- [ ] すべての更新が完了している
- [ ] サイト表示に問題がない
- [ ] 管理画面が正常に動作する
- [ ] コンソールにエラーがない
- [ ] 作業記録を残した
- [ ] クライアントに完了報告した
- [ ] バックアップを適切に保管した

### 作業記録テンプレート

| 項目 | 内容 |
|------|------|
| 作業日 | 2026/01/XX |
| 作業者 | |
| 対象サイト | |
| 作業内容 | |
| 変更前 | |
| 変更後 | |
| 確認結果 | |
| 備考 | |

---

## 改訂履歴

| 日付 | 内容 |
|------|------|
| 2026/01/11 | 初版作成 |
