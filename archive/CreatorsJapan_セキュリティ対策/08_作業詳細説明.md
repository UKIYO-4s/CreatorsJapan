# 作業詳細説明

各作業の「何をするか」「なぜするか」「リスク」「影響範囲」を詳細に説明します。

---

## 1. REST API コメント制限

### 何をするか

WordPressのREST API（`/wp-json/wp/v2/comments`）経由でのコメント投稿を制限します。

**実装方法**: `functions.php` に以下のようなコードを追加

```php
// REST API経由のコメント投稿を無効化
add_filter('rest_pre_insert_comment', function($prepared_comment, $request) {
    return new WP_Error(
        'rest_comment_disabled',
        'REST API経由のコメント投稿は無効です',
        array('status' => 403)
    );
}, 10, 2);
```

### なぜするか

| 理由 | 説明 |
|------|------|
| スパムの侵入経路 | REST APIは認証なしでコメント投稿可能な場合がある |
| 会員制サイトの穴 | 会員制プラグインがREST APIを保護していない可能性 |
| ボット攻撃 | 自動化されたスパム投稿の主要経路 |

### リスク

| リスク | 可能性 | 対処法 |
|--------|--------|--------|
| 正規のコメント機能への影響 | 低 | 通常のコメントフォームは別経路なので影響なし |
| 外部アプリ連携の停止 | 中 | REST API経由でコメント投稿するアプリがあれば動作しなくなる |
| プラグインとの競合 | 低 | 同様の機能を持つプラグインがあれば重複する |

### 影響範囲

| 影響を受けるもの | 影響を受けないもの |
|------------------|-------------------|
| REST API経由のコメント投稿 | 通常のコメントフォーム |
| 外部ツールからのコメント | 管理画面からのコメント |
| | RSS/メール経由の通知 |

### 確認方法

```bash
# 制限前（200 OKが返る）
curl -X POST https://salon.creators-jp.com/wp-json/wp/v2/comments \
  -H "Content-Type: application/json" \
  -d '{"post": 1, "content": "test"}'

# 制限後（403 Forbiddenが返る）
# → "REST API経由のコメント投稿は無効です"
```

---

## 2. XMLRPC 無効化

### 何をするか

`xmlrpc.php` へのアクセスを完全にブロックします。

**実装方法**: `.htaccess` に以下を追加

```apache
# xmlrpc.php 無効化
<files xmlrpc.php>
order allow,deny
deny from all
</files>
```

### なぜするか

| 理由 | 説明 |
|------|------|
| ブルートフォース攻撃 | xmlrpc.phpを使って大量のログイン試行が可能 |
| DDoS増幅攻撃 | pingback機能を悪用したDDoS攻撃の踏み台になる |
| コメントスパム | xmlrpc経由でのコメント投稿が可能 |
| レガシー機能 | 2024年以降、ほぼ使われない古い仕組み |

### リスク

| リスク | 可能性 | 対処法 |
|--------|--------|--------|
| **Jetpack連携の停止** | 高 | Jetpack使用時は要確認（今回は使用していない） |
| **WordPress公式アプリの停止** | 高 | スマホアプリからの投稿ができなくなる |
| 外部ブログツールの停止 | 中 | Windows Live Writer等が使えなくなる |
| pingback/trackbackの停止 | 低 | 他サイトからの通知が届かなくなる（今は使われない） |

### 影響範囲

| 影響を受けるもの | 影響を受けないもの |
|------------------|-------------------|
| WordPress公式スマホアプリ | ブラウザからの管理 |
| Jetpack（一部機能） | REST API |
| 外部ブログ投稿ツール | 通常のコメント |
| pingback/trackback | メール投稿 |

### 事前確認事項

**必ずクライアントに確認**:
- [ ] WordPressスマホアプリを使用しているか？
- [ ] Jetpackプラグインを使用しているか？
- [ ] 外部ツールから記事を投稿しているか？

### 確認方法

```bash
# 無効化前（200 OKまたはXMLレスポンス）
curl -I https://salon.creators-jp.com/xmlrpc.php

# 無効化後（403 Forbidden）
curl -I https://salon.creators-jp.com/xmlrpc.php
# → HTTP/1.1 403 Forbidden
```

---

## 3. プラグイン削除

### 何をするか

停止中（無効化済み）のプラグインを完全に削除します。

**対象プラグイン（creators-jp.com）**:

| プラグイン | 用途 | 削除判断 |
|-----------|------|----------|
| Hello Dolly | サンプル（機能なし） | **即削除可** |
| PORIPU Gutenberg | PORIPU専用（SWELLでは不要） | **即削除可** |
| ProfilePress | 会員機能 | **要確認** |
| TypeSquare Webfonts | Webフォント | **要確認** |
| User Role Editor | 権限編集 | **要確認** |
| カスタム Twitter フィード | SNS連携 | **要確認** |

### なぜするか

| 理由 | 説明 |
|------|------|
| 攻撃対象の削減 | 停止中でもファイルは存在し、脆弱性を突かれる可能性 |
| 管理の簡素化 | 不要なプラグインがあると更新管理が煩雑 |
| パフォーマンス | わずかだがサーバー負荷が減る |

### リスク

| リスク | 可能性 | 対処法 |
|--------|--------|--------|
| **必要な機能の削除** | 中 | 削除前に使用状況を必ず確認 |
| データベースの残骸 | 低 | 削除後もDB内にデータが残る場合あり |
| 復元の手間 | 低 | 再インストールは可能だが設定は失われる |

### 削除前の確認フロー

```
1. プラグインの役割を確認
   └─ 何のためのプラグインか？

2. 使用状況を確認
   └─ サイト内で実際に使われているか？
   └─ ショートコード等が埋め込まれていないか？

3. クライアントに確認
   └─ 今後使用する予定はあるか？

4. バックアップ
   └─ プラグインフォルダをFTPでダウンロード
   └─ DBバックアップ

5. 削除実行
   └─ 管理画面から削除

6. 動作確認
   └─ サイト表示に問題がないか確認
```

### 影響範囲

| 削除対象 | 起こりうる問題 |
|----------|---------------|
| Hello Dolly | なし（管理画面に歌詞を表示するだけ） |
| PORIPU Gutenberg | なし（SWELLテーマでは不要） |
| ProfilePress | 会員登録機能が消える可能性 |
| TypeSquare Webfonts | Webフォントが表示されなくなる |
| User Role Editor | カスタム権限が失われる可能性 |
| Twitter フィード | Twitterタイムラインが表示されなくなる |

---

## 4. テーマ削除

### 何をするか

停止中（使用していない）のテーマを削除します。

**対象**: 13テーマ（SWELLと子テーマ以外すべて）

### なぜするか

| 理由 | 説明 |
|------|------|
| 攻撃対象の削減 | 古いテーマの脆弱性を突かれる可能性 |
| 更新負荷の削減 | 使わないテーマの更新管理が不要になる |
| 容量削減 | ディスク容量の節約 |

### リスク

| リスク | 可能性 | 対処法 |
|--------|--------|--------|
| 必要なテーマの削除 | 低 | 現在有効なテーマは削除されない |
| 子テーマの親削除 | 低 | 親テーマ削除前に依存関係を確認 |

### 削除のルール

**残すテーマ**:
- 現在有効なテーマ（SWELL）
- 子テーマ（SWELL CHILD等）
- デフォルトテーマ1つ（Twenty Twenty-Four等）← 緊急時の切り替え用

**削除するテーマ**:
- 上記以外のすべて

### 確認方法

```
削除前: テーマ一覧に15テーマ
削除後: テーマ一覧に2-3テーマ（SWELL, SWELL CHILD, Twenty Twenty-Four）
```

---

## 5. プラグイン/テーマ更新

### 何をするか

更新待ちのプラグイン（13件）とテーマ（7件）を最新版に更新します。

### なぜするか

| 理由 | 説明 |
|------|------|
| 脆弱性の修正 | 古いバージョンには既知の脆弱性がある可能性 |
| AIOSEO緊急 | セキュリティ修正を含む更新が保留中 |
| 互換性維持 | WordPress本体との互換性を保つ |

### リスク

| リスク | 可能性 | 対処法 |
|--------|--------|--------|
| **表示崩れ** | 中 | バックアップ後に1件ずつ更新、確認 |
| **機能停止** | 中 | 更新後すぐに動作確認 |
| **プラグイン競合** | 低 | エラー発生時はロールバック |
| **PHP非互換** | 低 | 更新前にPHP要件を確認 |

### 更新手順

```
1. バックアップ取得
   └─ データベース
   └─ wp-content フォルダ

2. 低トラフィック時間帯を選択
   └─ 深夜または早朝推奨

3. 1件ずつ更新
   └─ 一括更新しない（問題発生時の切り分けのため）
   └─ セキュリティ更新を優先（AIOSEO等）

4. 更新ごとに確認
   └─ サイト表示確認
   └─ 管理画面動作確認
   └─ 主要機能テスト

5. 問題発生時
   └─ 即座に該当プラグインを無効化
   └─ バックアップから復元
   └─ 原因調査
```

### 表示崩れが起きやすいパターン

| パターン | 原因 | 対処法 |
|----------|------|--------|
| CSSが崩れる | キャッシュが古い | キャッシュクリア |
| ショートコードが表示される | プラグインが無効化 | プラグイン再有効化 |
| 白い画面（WSOD） | PHPエラー | FTPでプラグイン無効化 |
| 500エラー | メモリ不足/競合 | エラーログ確認 |

---

## 6. 二要素認証（2FA）導入

### 何をするか

WordPressログイン時に、パスワードに加えてワンタイムパスワード（TOTP）を要求します。

**実装方法**: プラグイン使用
- Two-Factor（WordPress公式推奨）
- WP 2FA
- Wordfence（2FA機能含む）

### なぜするか

| 理由 | 説明 |
|------|------|
| 不正ログイン防止 | パスワードが漏洩しても侵入できない |
| ブルートフォース対策 | パスワード総当たり攻撃を無効化 |
| 管理者保護 | 管理者アカウントは特に狙われやすい |

### リスク

| リスク | 可能性 | 対処法 |
|--------|--------|--------|
| **ログインできなくなる** | 中 | バックアップコード発行、復旧手順を事前共有 |
| **スマホ紛失時のロック** | 中 | 管理者用の緊急解除方法を用意 |
| **クライアントの負担** | 高 | 導入支援と使い方説明が必要 |

### クライアントへの影響

| 影響 | 詳細 |
|------|------|
| ログイン手順の変更 | パスワード入力後にアプリでコード確認が必要 |
| アプリのインストール | Google Authenticator等のインストールが必要 |
| 初期設定の手間 | QRコード読み取りとバックアップコード保管 |

### 導入手順（クライアント向け）

```
1. スマホにアプリをインストール
   └─ Google Authenticator（推奨）
   └─ Microsoft Authenticator
   └─ Authy

2. WordPressにプラグインをインストール
   └─ Two-Factor プラグイン

3. ユーザー設定で2FAを有効化
   └─ QRコードをアプリでスキャン
   └─ 6桁のコードを入力して確認

4. バックアップコードを保管
   └─ スマホ紛失時の復旧用
   └─ 印刷またはパスワードマネージャーに保存

5. 以降のログイン
   └─ パスワード入力
   └─ アプリで6桁コードを確認
   └─ コード入力（30秒ごとに変わる）
```

### 緊急時の解除方法

2FAでログインできなくなった場合:

```
方法1: バックアップコードでログイン
方法2: FTPでプラグインを無効化（/wp-content/plugins/two-factor をリネーム）
方法3: データベースで2FA設定を削除（上級者向け）
```

---

## 7. セキュリティヘッダー追加

### 何をするか

HTTPレスポンスヘッダーにセキュリティ関連のヘッダーを追加します。

**実装方法**: `.htaccess` に以下を追加

```apache
# セキュリティヘッダー
<IfModule mod_headers.c>
    # XSS保護
    Header set X-XSS-Protection "1; mode=block"
    # MIMEタイプスニッフィング防止
    Header set X-Content-Type-Options "nosniff"
    # クリックジャッキング防止
    Header set X-Frame-Options "SAMEORIGIN"
    # リファラー制御
    Header set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>
```

### なぜするか

| ヘッダー | 防ぐ攻撃 |
|----------|----------|
| X-XSS-Protection | クロスサイトスクリプティング（XSS） |
| X-Content-Type-Options | MIMEスニッフィング攻撃 |
| X-Frame-Options | クリックジャッキング（iframe埋め込み） |
| Referrer-Policy | リファラー情報の漏洩 |

### リスク

| リスク | 可能性 | 対処法 |
|--------|--------|--------|
| iframe埋め込みの停止 | 中 | 外部サイトへの埋め込みができなくなる（意図的） |
| 古いブラウザでの問題 | 低 | 無視されるだけで実害なし |

### 確認方法

```bash
# ヘッダー確認
curl -I https://creators-jp.com

# 期待する出力
X-XSS-Protection: 1; mode=block
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
Referrer-Policy: strict-origin-when-cross-origin
```

---

## 8. 重要ファイル保護

### 何をするか

`wp-config.php` 等の重要ファイルへの外部アクセスをブロックします。

**実装方法**: `.htaccess` に以下を追加

```apache
# wp-config.php 保護
<files wp-config.php>
order allow,deny
deny from all
</files>

# .htaccess 自体の保護
<files .htaccess>
order allow,deny
deny from all
</files>
```

### なぜするか

| ファイル | 含まれる情報 | 漏洩時のリスク |
|----------|-------------|---------------|
| wp-config.php | DB接続情報、認証キー | サイト完全制御 |
| .htaccess | サーバー設定 | 設定改ざん |

### リスク

| リスク | 可能性 | 対処法 |
|--------|--------|--------|
| 正常なアクセスへの影響 | なし | これらのファイルは直接アクセスされるべきでない |

### 確認方法

```bash
# 保護前（ファイル内容が見える可能性）
curl https://creators-jp.com/wp-config.php

# 保護後（403 Forbidden）
curl https://creators-jp.com/wp-config.php
# → 403 Forbidden
```

---

## まとめ：リスク一覧

| 作業 | リスク度 | 主なリスク | 必須確認事項 |
|------|----------|-----------|-------------|
| REST API制限 | 低 | 外部アプリ停止 | 連携アプリの有無 |
| XMLRPC無効化 | 中 | スマホアプリ停止 | アプリ使用の有無 |
| プラグイン削除 | 中 | 機能消失 | 使用状況の確認 |
| テーマ削除 | 低 | なし | 親テーマの確認 |
| 更新適用 | 中 | 表示崩れ | バックアップ |
| 2FA導入 | 中 | ログイン不可 | 復旧手順の共有 |
| セキュリティヘッダー | 低 | iframe停止 | 埋め込み使用の有無 |
| ファイル保護 | 低 | なし | なし |

---

## 改訂履歴

| 日付 | 内容 |
|------|------|
| 2026/01/11 | 初版作成 |
