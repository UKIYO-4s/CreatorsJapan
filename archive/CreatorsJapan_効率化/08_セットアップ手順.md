# セットアップ手順

## 1. GCPプロジェクト作成

### Step 1: プロジェクト作成

1. [Google Cloud Console](https://console.cloud.google.com/) にアクセス
2. プロジェクト選択 → 「新しいプロジェクト」
3. 設定:
   - プロジェクト名: `creators-japan-portal`
   - 組織: なし（個人）
4. 「作成」をクリック

### Step 2: API有効化

プロジェクト選択後、以下のAPIを有効化:

```
APIs & Services → ライブラリ → 検索して有効化
```

| API名 | 用途 |
|-------|------|
| Google Analytics Data API | GA4データ取得 |
| Google Search Console API | GSCデータ取得 |

### Step 3: サービスアカウント作成

```
IAM と管理 → サービスアカウント → サービスアカウントを作成
```

1. **サービスアカウントの詳細**
   - 名前: `portal-api-access`
   - ID: `portal-api-access`
   - 説明: `Creators Japan Portal API Access`

2. **ロール付与**（スキップ可）
   - 特にロール不要（外部サービスへのアクセスのみ）

3. **キーを作成**
   - 「キーを作成」→ JSON形式
   - ダウンロードされた `xxx.json` を安全に保管

### Step 4: サービスアカウントメールの確認

作成後、以下の形式のメールアドレスが発行される:

```
portal-api-access@creators-japan-portal.iam.gserviceaccount.com
```

このメールアドレスをGA4/GSCに権限付与する際に使用。

---

## 2. Cloudflareリソース作成

### Step 1: Cloudflareアカウント確認

[Cloudflare Dashboard](https://dash.cloudflare.com/) にログイン

### Step 2: Workers & Pages

```bash
# wrangler CLIインストール（未インストールの場合）
npm install -g wrangler

# ログイン
wrangler login

# Pagesプロジェクト作成
wrangler pages project create creators-japan-portal
```

### Step 3: KV Namespace作成

```bash
# KV作成
wrangler kv:namespace create CACHE

# 出力例:
# { binding = "CACHE", id = "xxxx" }
# → wrangler.tomlに記載
```

### Step 4: D1データベース作成

```bash
# D1作成
wrangler d1 create portal-db

# 出力例:
# { binding = "DB", database_name = "portal-db", database_id = "xxxx" }
# → wrangler.tomlに記載
```

### Step 5: wrangler.toml作成

```toml
name = "creators-japan-portal"
compatibility_date = "2024-01-01"
pages_build_output_dir = "dist"

[[kv_namespaces]]
binding = "CACHE"
id = "ここにKV IDを記載"

[[d1_databases]]
binding = "DB"
database_name = "portal-db"
database_id = "ここにD1 IDを記載"

[vars]
ADMIN_EMAILS = '["admin@example.com"]'
```

---

## 3. Cloudflare Access設定

### Step 1: アプリケーション作成

```
Zero Trust → Access → Applications → Add an application
```

1. **Self-hosted** を選択
2. 設定:
   - Application name: `Creators Japan Portal`
   - Session Duration: `24 hours`
   - Application domain: `portal.creators-jp.com`（予定ドメイン）

### Step 2: ポリシー作成

**管理者ポリシー:**
```
Policy name: Admin Access
Action: Allow
Include:
  - Emails: admin@example.com（あなたのメール）
```

**クライアントポリシー:**
```
Policy name: Client Access
Action: Allow
Include:
  - Emails ending in: @creators-jp.com
```

---

## 4. Secrets設定

サービスアカウントキー等の機密情報:

```bash
# サービスアカウントキー（JSON全体を設定）
wrangler secret put GOOGLE_SERVICE_ACCOUNT_KEY
# → キーファイルの内容をペースト

# Discord Webhook URL
wrangler secret put DISCORD_WEBHOOK_URL_PUBLIC
wrangler secret put DISCORD_WEBHOOK_URL_SALON
```

---

## 5. クライアント側での権限付与

### GA4への権限付与（クライアント作業）

```
GA4管理画面 → 管理 → プロパティのアクセス管理 → ユーザーを追加

メールアドレス: portal-api-access@creators-japan-portal.iam.gserviceaccount.com
ロール: 閲覧者
```

### Search Consoleへの権限付与（クライアント作業）

```
Search Console → 設定 → ユーザーと権限 → ユーザーを追加

メールアドレス: portal-api-access@creators-japan-portal.iam.gserviceaccount.com
権限: フル
```

---

## チェックリスト

### GCP

- [ ] プロジェクト作成完了
- [ ] Google Analytics Data API 有効化
- [ ] Google Search Console API 有効化
- [ ] サービスアカウント作成完了
- [ ] サービスアカウントキー（JSON）ダウンロード

### Cloudflare

- [ ] wrangler ログイン完了
- [ ] Pages プロジェクト作成完了
- [ ] KV Namespace 作成完了
- [ ] D1 Database 作成完了
- [ ] Access アプリケーション作成完了
- [ ] Access ポリシー設定完了

### Secrets

- [ ] GOOGLE_SERVICE_ACCOUNT_KEY 設定完了
- [ ] DISCORD_WEBHOOK_URL_PUBLIC 設定完了
- [ ] DISCORD_WEBHOOK_URL_SALON 設定完了

### クライアント側（依頼後）

- [ ] GA4（公式）閲覧者権限付与
- [ ] GA4（サロン）閲覧者権限付与
- [ ] GSC（公式）ユーザー追加
- [ ] GSC（サロン）ユーザー追加
- [ ] Discord Webhook URL 共有

---

## 改訂履歴

| 日付 | 内容 |
|------|------|
| 2026/01/12 | 初版作成 |
