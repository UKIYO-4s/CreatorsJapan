# ポータルシステム設計書

## コンセプト

Creators Japan向けの業務効率化ポータルサイト。
Cloudflare Access による認証で、管理者（運用担当）とクライアントそれぞれ専用のダッシュボードを提供。

---

## 設計思想（大前提）

### 1. 永続運用を前提とした堅牢性

このシステムは**一時的なツールではなく、永続的に運用される基盤**である。

```
❌ NG: 「とりあえず動く」実装
✅ OK: 「5年後も安定稼働する」実装
```

**堅牢性の原則:**
- 外部APIの仕様変更に備えたエラーハンドリング
- 認証トークンの自動更新・失効対応
- ネットワーク障害時のグレースフルデグラデーション
- データ整合性チェックの自動実行
- ログ・監視による異常検知

### 2. 各部の整合性保証

システム全体で**データの一貫性**を維持する。

```
┌─────────────────────────────────────────────────────────────┐
│                    整合性チェックポイント                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   [KV Cache] ←──── 整合性 ────→ [Source API]               │
│       │                              │                      │
│       └──────── TTL管理 ─────────────┘                      │
│                                                             │
│   [D1 Summary] ←─── 整合性 ────→ [KV Data]                  │
│       │                              │                      │
│       └──────── 月次集計時検証 ───────┘                      │
│                                                             │
│   [Frontend State] ←─ 整合性 ─→ [API Response]              │
│       │                              │                      │
│       └──────── fromCache フラグ ────┘                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**整合性保証の手段:**
- キャッシュにはタイムスタンプ・ハッシュを必ず付与
- API応答には `fromCache` / `cachedAt` を含め透明性確保
- 差分検出失敗時はキャッシュクリア + 再取得
- 月次サマリー保存前にソースデータとの突合

### 3. クライアント負担ゼロの設計

**最重要原則: ポータルの利用自体がタスクになってはならない**

```
❌ NG: クライアントが「ポータルを確認する」作業が発生
✅ OK: クライアントは「必要なときに見るだけ」で完結
```

**ゼロタスク設計:**

| 従来の負担 | ポータルでの解決 |
|------------|------------------|
| 毎月レポートを依頼する | 自動生成・自動通知 |
| データを探す・開く | ダッシュボードで即時表示 |
| 複数ツールを行き来 | 1画面に集約 |
| 更新を気にする | 常に最新データ |
| 確認したことを報告 | 不要（閲覧ログで把握可） |

**実現手段:**
- **プッシュ型通知**: Discord/メールで自動通知、ポータルは補助
- **ゼロクリック閲覧**: ログイン後即座にサマリー表示
- **受動的UX**: クライアントからのアクション不要で情報が届く
- **通知完結型**: 重要情報はDiscord通知で完結、ポータルは詳細確認用

### 4. エラー耐性設計

```
┌─────────────────────────────────────────────────────────────┐
│                      障害発生時の挙動                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   GA4 API障害        → KVキャッシュを返却 + 警告表示         │
│   GSC API障害        → KVキャッシュを返却 + 警告表示         │
│   公式サイト障害     → 前回の記事一覧を返却                  │
│   Discord障害        → リトライキュー + 管理者通知           │
│   KV障害            → D1フォールバック or 直接API取得        │
│   D1障害            → 読み取り専用モード                    │
│                                                             │
│   全障害共通:                                                │
│   - ユーザーには「一部データが古い可能性」を明示              │
│   - 管理者にはSlack/メールで障害通知                         │
│   - 自動復旧試行（指数バックオフ）                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5. 保守性の確保

**将来の変更に備えた設計:**
- API仕様変更: アダプターパターンで吸収
- 機能追加: モジュラー設計で影響範囲を限定
- 認証方式変更: Cloudflare Access抽象化
- データソース追加: プラグイン形式で拡張

---

## システム全体像

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Creators Japan 業務ポータル                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────┐                      ┌─────────────┐                     │
│   │   管理者    │                      │  クライアント │                     │
│   │  (Shoei)   │                      │ (CJ担当者)  │                     │
│   └──────┬──────┘                      └──────┬──────┘                     │
│          │                                    │                            │
│          ▼                                    ▼                            │
│   ┌─────────────────────────────────────────────────────┐                  │
│   │              Cloudflare Access                      │                  │
│   │         (認証・アクセス制御・ロール管理)               │                  │
│   └─────────────────────────────────────────────────────┘                  │
│          │                                    │                            │
│          ▼                                    ▼                            │
│   ┌─────────────────────────────────────────────────────┐                  │
│   │              Cloudflare Workers                     │                  │
│   │           （オンデマンドデータ取得）                   │                  │
│   └─────────────────────────────────────────────────────┘                  │
│          │                                                                 │
│          ├──────────┬──────────┬──────────┬──────────┐                     │
│          ▼          ▼          ▼          ▼          ▼                     │
│   ┌──────────┐┌──────────┐┌──────────┐┌──────────┐┌──────────┐             │
│   │  GA4 API ││  GSC API ││ 公式サイト ││  Discord ││    KV    │             │
│   │(リアルタイム)││(リアルタイム)││(差分検出) ││ Webhook ││ (キャッシュ) │             │
│   └──────────┘└──────────┘└──────────┘└──────────┘└──────────┘             │
│                                                                             │
│   ※ D1は最小限（設定・月次サマリーのみ）                                       │
│   ※ データは基本オンデマンド取得、KVでキャッシュ                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## データ取得戦略

### 原則: オンデマンド取得 + KVキャッシュ

DBに大量データを蓄積せず、アクセス時にリアルタイム取得。
KVで最新状態をキャッシュし、差分検出で効率化。

### 記事データ: KV差分検出方式

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   ユーザーアクセス                                            │
│         │                                                   │
│         ▼                                                   │
│   ┌───────────────┐      ┌───────────────┐                 │
│   │  KV (cached)  │ ←──→ │  公式サイト     │                 │
│   │  前回のDOM    │  比較  │  現在のDOM     │                 │
│   └───────────────┘      └───────────────┘                 │
│         │                       │                          │
│         ▼                       ▼                          │
│   ┌─────────────────────────────────────────┐              │
│   │            差分チェック                   │              │
│   └─────────────────────────────────────────┘              │
│         │                       │                          │
│    差分なし                   差分あり                       │
│         │                       │                          │
│         ▼                       ▼                          │
│   KVのデータを              新規記事を取得                    │
│   そのまま返却              KVを更新                         │
│                             新データを返却                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### GA4 / Search Console: リアルタイムAPI取得

```
ユーザーアクセス → Workers → GA4 API / GSC API → レスポンス
                              ↓
                     短期キャッシュ（KV: 1時間程度）
```

---

## 技術スタック

| レイヤー | 技術 | 選定理由 |
|----------|------|----------|
| フロントエンド | React + Vite | 高速、モダン、拡張性 |
| スタイリング | Tailwind CSS | 効率的なUI構築 |
| ホスティング | Cloudflare Pages | 無料、高速、Workers連携 |
| 認証 | Cloudflare Access | ゼロトラスト、簡単設定 |
| バックエンド | Cloudflare Workers | サーバーレス、低コスト |
| **キャッシュ** | **Cloudflare KV** | 差分検出、高速読み取り |
| データベース | Cloudflare D1 | 最小限（設定のみ） |
| 外部連携 | GA4 API, Search Console API, Discord Webhook | 既存システム活用 |

**ランニングコスト**: 基本無料（Cloudflare Free Tier内で運用可能）

---

## 認証設計

### Cloudflare Access 設定

| 設定項目 | 管理者 | クライアント |
|----------|--------|--------------|
| 認証方式 | メール OTP / Google | メール OTP / Google |
| アクセスポリシー | admin@example.com | *@creators-jp.com |
| ロール | admin | client |
| アクセス範囲 | 全機能 | 閲覧 + 限定操作 |

### ルーティング

```
/                     → ログインページ
/admin/*              → 管理者専用（admin ロール必須）
/client/*             → クライアント専用（client ロール必須）
/api/*                → APIエンドポイント（認証必須）
```

---

## 機能一覧（フェーズ別）

### Phase 1: MVP（簡易版）- 3万円

| 機能 | 管理者 | クライアント | 実装 |
|------|--------|--------------|------|
| ログイン | ○ | ○ | Cloudflare Access |
| ブログ記事報告 | 投稿 | 閲覧 | D1 + Workers |
| 記事一覧表示 | ○ | ○ | React Table |
| **GA月次レポート** | 設定・確認 | 閲覧 | GA4 API |
| **Search Consoleレポート** | 設定・確認 | 閲覧 | Search Console API |
| **Discord自動投稿** | 設定 | - | Webhook |
| **レポート履歴** | ○ | ○ | D1 |

**MVP機能詳細:**

1. **ブログ記事報告**
   - 管理者: 記事URL入力 → 自動でタイトル・公開日取得 → 保存
   - クライアント: 投稿された記事一覧を閲覧
   - 自動: OGP情報取得、公開日取得

2. **GA4レポート自動化**
   - GA4 APIで2サイト分のデータを自動取得
   - 月次でスプレッドシート連携・ポータル表示
   - 前月比較、人気記事ランキング

3. **Search Consoleレポート**
   - 検索クエリ（どんなキーワードで検索されたか）
   - 表示回数・クリック数・CTR・平均順位
   - ページ別の検索パフォーマンス
   - GA4データと組み合わせた分析

4. **Discord自動投稿**
   - 毎月1日に所定チャンネルへ自動投稿
   - サイト別に投稿先を分離
   - GA4 + Search Console のサマリーを含む

### Phase 2: 包括版（要ヒアリング）

| 機能 | 管理者 | クライアント | 実装 |
|------|--------|--------------|------|
| セキュリティ監視 | ○ | アラート受信 | Workers Cron |
| タスク管理 | ○ | 進捗確認 | D1 |
| 請求書管理 | 作成 | 閲覧・DL | PDF生成 |
| ファイル共有 | アップロード | ダウンロード | R2 |
| 通知設定 | ○ | ○ | Discord/Email |

---

## ストレージ設計

### KV（Cloudflare KV）- メインキャッシュ

リアルタイムデータの一時保存に使用。

```
KV Namespace: PORTAL_CACHE

┌─────────────────────────────────────────────────────────────┐
│  Key                          │  Value                      │
├───────────────────────────────┼─────────────────────────────┤
│  articles:public              │  { articles: [...], hash }  │
│  articles:salon               │  { articles: [...], hash }  │
│  ga:public:2026-01            │  { data: {...}, fetchedAt } │
│  ga:salon:2026-01             │  { data: {...}, fetchedAt } │
│  gsc:public:2026-01           │  { data: {...}, fetchedAt } │
│  gsc:salon:2026-01            │  { data: {...}, fetchedAt } │
└───────────────────────────────┴─────────────────────────────┘

TTL設定:
- articles:*     → 24時間（差分検出で更新）
- ga:*           → 1時間
- gsc:*          → 1時間
```

### D1（Cloudflare D1）- 最小限の永続データ

設定情報と月次サマリーのみ保存。

```sql
-- システム設定
CREATE TABLE settings (
  key TEXT PRIMARY KEY,
  value JSON NOT NULL,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 月次サマリー（履歴用）
CREATE TABLE monthly_summaries (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  site TEXT NOT NULL,           -- 'salon' / 'public'
  year_month TEXT NOT NULL,     -- '2026-01'
  ga_summary JSON,              -- GA4月次サマリー
  gsc_summary JSON,             -- GSC月次サマリー
  article_count INTEGER,        -- 公開記事数
  discord_notified_at DATETIME, -- Discord通知日時
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(site, year_month)
);

-- タスク（Phase 2）
CREATE TABLE tasks (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  description TEXT,
  status TEXT DEFAULT 'pending',
  due_date DATE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### データフロー

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   リアルタイムデータ           永続データ                     │
│   ┌─────────────┐            ┌─────────────┐               │
│   │     KV      │            │     D1      │               │
│   │   (キャッシュ) │            │  (最小限)   │               │
│   └──────┬──────┘            └──────┬──────┘               │
│          │                          │                      │
│   ・記事一覧                    ・設定                      │
│   ・GA4データ                   ・月次サマリー                │
│   ・GSCデータ                   ・タスク                     │
│          │                          │                      │
│          └──────────┬───────────────┘                      │
│                     │                                       │
│                     ▼                                       │
│              ┌─────────────┐                               │
│              │   Workers   │                               │
│              │  (API層)    │                               │
│              └─────────────┘                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## API設計

### MVP API（オンデマンド取得）

```
# 記事データ（KV差分検出）
GET    /api/articles/:site      # 記事一覧を取得（差分検出付き）
                                # site: 'public' | 'salon'
                                # → KVキャッシュ確認 → 差分あれば更新 → 返却

# GA4データ（リアルタイム取得）
GET    /api/ga/:site            # GA4データを取得
                                # クエリパラメータ: period=2026-01
                                # → KVキャッシュ確認（1時間有効）→ なければAPI取得

# Search Consoleデータ（リアルタイム取得）
GET    /api/gsc/:site           # GSCデータを取得
                                # クエリパラメータ: period=2026-01
                                # → KVキャッシュ確認（1時間有効）→ なければAPI取得

# 月次サマリー
GET    /api/summaries/:site     # 月次サマリー履歴を取得
POST   /api/summaries/:site     # 月次サマリーを保存（自動/手動）

# Discord通知
POST   /api/discord/notify      # Discord通知を送信（管理者のみ）
                                # body: { site, type: 'monthly' | 'article' }

# ユーティリティ
POST   /api/fetch-og            # URLからOGP情報を取得
```

### API レスポンス例

```typescript
// GET /api/articles/public
{
  "articles": [
    {
      "url": "https://creators-jp.com/blog/...",
      "title": "動画編集の始め方",
      "publishedDate": "2026-01-10",
      "ogImage": "https://..."
    }
  ],
  "lastUpdated": "2026-01-12T00:00:00Z",
  "fromCache": true
}

// GET /api/ga/public?period=2026-01
{
  "period": "2026-01",
  "pageViews": 45230,
  "users": 12500,
  "newUsers": 8200,
  "avgSessionDuration": 145,
  "topPages": [...],
  "fromCache": true,
  "cachedAt": "2026-01-12T00:00:00Z"
}
```

---

## UI設計

### 管理者ダッシュボード

```
┌─────────────────────────────────────────────────────────────┐
│  [Logo] Creators Japan Portal          [User] ▼  [Logout]  │
├──────────────┬──────────────────────────────────────────────┤
│              │                                              │
│  Dashboard   │   📊 ダッシュボード                           │
│  ──────────  │   ─────────────────────────────────────────  │
│  📝 記事報告  │                                              │
│  📈 GAレポート│   ┌─────────────┐  ┌─────────────┐          │
│  ⚙️ 設定     │   │ 今月の記事   │  │ 今月のPV    │          │
│              │   │     5       │  │   45,230   │          │
│              │   └─────────────┘  └─────────────┘          │
│              │                                              │
│              │   📝 最近の記事報告                           │
│              │   ┌─────────────────────────────────────┐   │
│              │   │ 2026/01/10 - 動画編集の始め方       │   │
│              │   │ 2026/01/08 - Premiere Pro入門       │   │
│              │   │ 2026/01/05 - 副業で稼ぐコツ         │   │
│              │   └─────────────────────────────────────┘   │
│              │                                              │
│              │   [+ 新しい記事を報告]                        │
│              │                                              │
└──────────────┴──────────────────────────────────────────────┘
```

### クライアントダッシュボード

```
┌─────────────────────────────────────────────────────────────┐
│  [Logo] Creators Japan Portal          [User] ▼  [Logout]  │
├──────────────┬──────────────────────────────────────────────┤
│              │                                              │
│  Dashboard   │   📊 レポート                                │
│  ──────────  │   ─────────────────────────────────────────  │
│  📝 記事一覧  │                                              │
│  📈 アクセス  │   今月のサイト状況                            │
│  📁 資料     │   ┌─────────────┐  ┌─────────────┐          │
│              │   │ 公開記事数   │  │ 合計PV      │          │
│              │   │     52      │  │  125,680   │          │
│              │   └─────────────┘  └─────────────┘          │
│              │                                              │
│              │   📝 最新の記事                              │
│              │   ┌─────────────────────────────────────┐   │
│              │   │ ✅ 2026/01/10 - 動画編集の始め方     │   │
│              │   │ ✅ 2026/01/08 - Premiere Pro入門     │   │
│              │   └─────────────────────────────────────┘   │
│              │                                              │
└──────────────┴──────────────────────────────────────────────┘
```

---

## ディレクトリ構成

```
creators-japan-portal/
├── .github/
│   └── ISSUE_TEMPLATE/
├── src/
│   ├── components/          # UIコンポーネント
│   │   ├── common/          # 共通コンポーネント
│   │   ├── admin/           # 管理者用
│   │   └── client/          # クライアント用
│   ├── pages/               # ページコンポーネント
│   │   ├── admin/
│   │   └── client/
│   ├── hooks/               # カスタムフック
│   │   ├── useArticles.ts   # 記事データ取得
│   │   ├── useGA.ts         # GA4データ取得
│   │   └── useGSC.ts        # GSCデータ取得
│   ├── lib/                 # ユーティリティ
│   │   └── api.ts           # API クライアント
│   ├── types/               # 型定義
│   └── App.tsx
├── functions/               # Cloudflare Workers (Pages Functions)
│   └── api/
│       ├── articles/
│       │   └── [site].ts    # 記事一覧（KV差分検出）
│       ├── ga/
│       │   └── [site].ts    # GA4データ取得
│       ├── gsc/
│       │   └── [site].ts    # GSCデータ取得
│       ├── summaries/
│       │   └── [site].ts    # 月次サマリー
│       ├── discord/
│       │   └── notify.ts    # Discord通知
│       └── fetch-og.ts      # OGP取得
├── workers/                 # 共有ワーカーロジック
│   ├── kv-cache.ts          # KVキャッシュ操作
│   ├── scraper.ts           # 記事スクレイピング
│   ├── ga-client.ts         # GA4 APIクライアント
│   ├── gsc-client.ts        # GSC APIクライアント
│   └── discord.ts           # Discord Webhook
├── public/
├── wrangler.toml            # Cloudflare設定（KV/D1バインディング）
├── schema.sql               # D1スキーマ（最小限）
├── package.json
├── tailwind.config.js
├── vite.config.ts
└── README.md
```

---

## 拡張性の担保

### 1. モジュラー設計

各機能を独立したモジュールとして実装：
- 記事報告モジュール
- GAレポートモジュール
- タスク管理モジュール
- etc.

### 2. プラグインパターン

新機能追加時のテンプレート：
```typescript
// 新機能追加例
interface PortalModule {
  name: string;
  routes: Route[];
  apiEndpoints: Endpoint[];
  menuItems: MenuItem[];
  permissions: Permission[];
}
```

### 3. マルチテナント対応準備

将来的に他クライアントにも展開可能な設計：
```sql
-- テナント分離（将来対応）
CREATE TABLE tenants (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  domain TEXT,
  settings JSON
);
```

---

## 改訂履歴

| 日付 | 内容 |
|------|------|
| 2026/01/11 | 初版作成 |
| 2026/01/12 | アーキテクチャ更新: KV差分検出方式採用、D1最小化 |
| 2026/01/12 | 設計思想（大前提）セクション追加: 永続運用・整合性・ゼロタスク |
